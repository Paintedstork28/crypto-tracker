<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Price Tracker &amp; Arbitrage</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      min-height: 100vh; background: #f5f6fa;
      font-family: system-ui, sans-serif; color: #1a1a2e;
      display: flex; flex-direction: column; align-items: center;
      padding: 40px 20px 60px;
    }
    h1 {
      font-size: 2rem; margin-bottom: 8px;
      background: linear-gradient(90deg, #f7931a, #627eea);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .subtitle { color: #888; font-size: 0.9rem; margin-bottom: 40px; }
    .section-title {
      font-size: 1.1rem; font-weight: 600; color: #666;
      margin: 36px 0 16px; text-transform: uppercase;
      letter-spacing: 1px; width: 100%; max-width: 960px; padding-left: 4px;
    }
    .section-title:first-of-type { margin-top: 0; }

    /* Cards */
    .cards { display: flex; gap: 24px; flex-wrap: wrap; justify-content: center; max-width: 960px; }
    .card {
      background: #fff; border: 1px solid #e2e4ea;
      border-radius: 16px; padding: 32px; width: 300px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
    .card.stablecoin { border-color: #c8e6c9; }
    .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .coin-icon { width: 40px; height: 40px; border-radius: 50%; }
    .coin-name { font-size: 1.2rem; font-weight: 600; color: #1a1a2e; }
    .coin-symbol { color: #999; font-size: 0.85rem; text-transform: uppercase; }
    .price { font-size: 2rem; font-weight: 700; margin-bottom: 16px; color: #1a1a2e; }
    .peg-status { display: inline-block; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
    .peg-ok { background: #e8f5e9; color: #2e7d32; }
    .peg-warn { background: #fff3e0; color: #e65100; }
    .stats { display: flex; justify-content: space-between; gap: 12px; }
    .stat-label { font-size: 0.75rem; color: #999; margin-bottom: 4px; }
    .stat-value { font-size: 0.9rem; font-weight: 500; color: #444; }
    .change-positive { color: #2e7d32; }
    .change-negative { color: #c62828; }

    /* Panels */
    .arb-panel {
      width: 100%; max-width: 960px; background: #fff;
      border: 1px solid #e2e4ea; border-radius: 16px; padding: 32px; margin-top: 16px;
    }
    .arb-panel h2 { font-size: 1.3rem; margin-bottom: 20px; color: #1a1a2e; }
    .arb-strategy { background: #f9fafb; border-radius: 12px; padding: 24px; margin-bottom: 20px; }
    .arb-flow { display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap; margin: 16px 0; }
    .arb-step {
      background: #fff; border: 1px solid #e2e4ea; border-radius: 10px;
      padding: 12px 18px; text-align: center; min-width: 140px;
    }
    .arb-step .step-num { font-size: 0.65rem; color: #627eea; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
    .arb-step .step-action { font-size: 0.95rem; font-weight: 600; color: #1a1a2e; }
    .arb-step .step-detail { font-size: 0.75rem; color: #999; margin-top: 4px; }
    .arb-arrow { color: #627eea; font-size: 1.2rem; }
    .arb-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-top: 16px; }
    .arb-stat { background: #f9fafb; border-radius: 10px; padding: 16px; border: 1px solid #e2e4ea; }
    .arb-stat .label { font-size: 0.75rem; color: #999; margin-bottom: 4px; }
    .arb-stat .value { font-size: 1.1rem; font-weight: 700; color: #1a1a2e; }
    .arb-stat .value.green { color: #2e7d32; }
    .arb-stat .value.red { color: #c62828; }
    .arb-stat .value.amber { color: #e65100; }
    .no-arb { color: #999; text-align: center; padding: 20px; font-size: 0.95rem; }

    /* Tables */
    .vol-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .vol-table th {
      text-align: left; font-size: 0.75rem; color: #999;
      padding: 8px 12px; border-bottom: 1px solid #e2e4ea;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .vol-table td { padding: 10px 12px; border-bottom: 1px solid #f0f1f5; font-size: 0.9rem; color: #444; }
    .vol-table tr:hover td { background: #f9fafb; }
    .rank-badge {
      display: inline-block; font-size: 0.6rem; padding: 2px 6px; border-radius: 3px;
      font-weight: 700; vertical-align: middle; margin-left: 6px;
    }
    .rank-1 { background: #ffd700; color: #1a1a2e; }
    .rank-2 { background: #c0c0c0; color: #1a1a2e; }
    .rank-3 { background: #cd7f32; color: #fff; }

    /* Dropdowns & inputs */
    .styled-select {
      background: #fff; border: 1px solid #d0d3da; border-radius: 8px;
      padding: 10px 14px; color: #1a1a2e; font-size: 0.95rem; outline: none;
      font-family: inherit; cursor: pointer; min-width: 180px;
    }
    .styled-select:focus { border-color: #627eea; }
    .calc-section { background: #f9fafb; border-radius: 12px; padding: 24px; margin-top: 20px; }
    .calc-section h3 { font-size: 1rem; margin-bottom: 16px; color: #1a1a2e; }
    .calc-row { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; }
    .calc-input {
      background: #fff; border: 1px solid #d0d3da; border-radius: 8px;
      padding: 12px 16px; color: #1a1a2e; font-size: 1.1rem; width: 240px;
      outline: none; font-family: inherit;
    }
    .calc-input:focus { border-color: #627eea; }
    .calc-input::placeholder { color: #bbb; }
    .calc-result { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
    .calc-result-item { background: #fff; border-radius: 10px; padding: 16px; border: 1px solid #e2e4ea; }
    .calc-result-item .label { font-size: 0.75rem; color: #999; margin-bottom: 4px; }
    .calc-result-item .value { font-size: 1.2rem; font-weight: 700; color: #1a1a2e; }

    /* Currency detail */
    .currency-leaderboard { overflow-x: auto; }
    .currency-detail { background: #f9fafb; border-radius: 12px; padding: 24px; margin-top: 16px; }

    /* Status */
    .status-bar { margin-top: 40px; display: flex; align-items: center; gap: 8px; color: #999; font-size: 0.8rem; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #2e7d32; }
    .dot.error { background: #c62828; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
    .loading .price { animation: pulse 1s infinite; opacity: 0.4; }
  </style>
</head>
<body>
  <h1>Crypto Price Tracker &amp; Arbitrage</h1>
  <p class="subtitle">Live prices from CoinGecko &middot; Auto-refreshes every 30s</p>

  <!-- 1. Crypto Prices -->
  <div class="section-title">Cryptocurrencies</div>
  <div class="cards" id="crypto-cards"></div>

  <!-- 2. Stablecoin Prices -->
  <div class="section-title">USD Stablecoins</div>
  <div class="cards" id="stable-cards"></div>

  <!-- 3. Arbitrage Strategy -->
  <div class="section-title">Arbitrage Strategy</div>
  <div class="arb-panel" id="arb-panel">
    <h2>Stablecoin Arbitrage (Round-Trip)</h2>
    <div id="arb-content"><p class="no-arb">Loading prices...</p></div>
  </div>

  <!-- 4. Most Profitable Currency -->
  <div class="section-title">Most Profitable Currency</div>
  <div class="arb-panel">
    <h2>Spread Comparison Across Top 20 Currencies</h2>
    <p style="color:#999; font-size:0.85rem; margin-bottom:16px;">
      Ranked by net spread. The wider the spread in a currency, the more profitable the arbitrage.
    </p>
    <div class="currency-leaderboard" id="currency-leaderboard">
      <p class="no-arb">Loading multi-currency data...</p>
    </div>
    <div style="margin-top:20px;">
      <label style="color:#999; font-size:0.85rem; margin-right:8px;">View detailed breakdown for:</label>
      <select class="styled-select" id="currency-detail-select">
        <option value="">Select a currency...</option>
      </select>
    </div>
    <div id="currency-detail"></div>
  </div>

  <!-- 5. Profit Calculator -->
  <div class="section-title">Profit Calculator</div>
  <div class="arb-panel">
    <div class="calc-section">
      <h3>Enter Your Investment Amount</h3>
      <div class="calc-row">
        <select class="styled-select" id="calc-currency-select"></select>
        <input type="number" class="calc-input" id="invest-input" placeholder="Enter amount" min="0">
      </div>
      <div class="calc-result" id="calc-result">
        <div class="calc-result-item">
          <div class="label">Investment in USD</div>
          <div class="value" id="calc-usd">--</div>
        </div>
        <div class="calc-result-item">
          <div class="label">Stablecoins Bought</div>
          <div class="value" id="calc-coins">--</div>
        </div>
        <div class="calc-result-item">
          <div class="label">Gross Profit (USD)</div>
          <div class="value" id="calc-gross-usd">--</div>
        </div>
        <div class="calc-result-item">
          <div class="label">Fee: Buy-Side (0.10%)</div>
          <div class="value amber" id="calc-fee-buy">--</div>
        </div>
        <div class="calc-result-item">
          <div class="label">Fee: Swap (0.05%)</div>
          <div class="value amber" id="calc-fee-swap">--</div>
        </div>
        <div class="calc-result-item">
          <div class="label">Fee: Sell-Side (0.10%)</div>
          <div class="value amber" id="calc-fee-sell">--</div>
        </div>
        <div class="calc-result-item">
          <div class="label">Fee: Network (0.02%)</div>
          <div class="value amber" id="calc-fee-network">--</div>
        </div>
        <div class="calc-result-item">
          <div class="label">Fee: Conversion Spread (0.03%)</div>
          <div class="value amber" id="calc-fee-spread">--</div>
        </div>
        <div class="calc-result-item">
          <div class="label">Total Fees (USD)</div>
          <div class="value red" id="calc-fees-total">--</div>
        </div>
        <div class="calc-result-item">
          <div class="label">Net Profit (Local Currency)</div>
          <div class="value green" id="calc-net-local">--</div>
        </div>
        <div class="calc-result-item">
          <div class="label">Net Profit (INR)</div>
          <div class="value green" id="calc-net-inr">--</div>
        </div>
        <div class="calc-result-item">
          <div class="label">Return on Investment</div>
          <div class="value" id="calc-roi">--</div>
        </div>
      </div>
    </div>
  </div>

  <div class="status-bar">
    <div class="dot" id="status-dot"></div>
    <span id="status-text">Connecting...</span>
  </div>

  <script>
    const coins = [
      { id: 'bitcoin',  symbol: 'BTC',  name: 'Bitcoin',  section: 'crypto', icon: 'https://assets.coingecko.com/coins/images/1/small/bitcoin.png' },
      { id: 'ethereum', symbol: 'ETH',  name: 'Ethereum', section: 'crypto', icon: 'https://assets.coingecko.com/coins/images/279/small/ethereum.png' },
      { id: 'solana',   symbol: 'SOL',  name: 'Solana',   section: 'crypto', icon: 'https://assets.coingecko.com/coins/images/4128/small/solana.png' },
      { id: 'tether',   symbol: 'USDT', name: 'Tether',   section: 'stable', icon: 'https://assets.coingecko.com/coins/images/325/small/Tether.png', peg: 1.0 },
      { id: 'usd-coin', symbol: 'USDC', name: 'USD Coin', section: 'stable', icon: 'https://assets.coingecko.com/coins/images/6319/small/usdc.png', peg: 1.0 },
      { id: 'dai',      symbol: 'DAI',  name: 'Dai',      section: 'stable', icon: 'https://assets.coingecko.com/coins/images/9956/small/Badge_Dai.png', peg: 1.0 },
    ];

    const stableIds = coins.filter(c => c.section === 'stable').map(c => c.id);

    const FEES = {
      buyTrade: 0.0010,
      swap:     0.0005,
      sellTrade:0.0010,
      network:  0.0002,
      fxSpread: 0.0003,
    };
    const TOTAL_FEE = Object.values(FEES).reduce((a, b) => a + b, 0);

    const currencies = [
      { code: 'usd', symbol: '$',  name: 'US Dollar' },
      { code: 'eur', symbol: '€',  name: 'Euro' },
      { code: 'gbp', symbol: '£',  name: 'British Pound' },
      { code: 'jpy', symbol: '¥',  name: 'Japanese Yen' },
      { code: 'cny', symbol: '¥',  name: 'Chinese Yuan' },
      { code: 'inr', symbol: '₹',  name: 'Indian Rupee' },
      { code: 'aud', symbol: 'A$', name: 'Australian Dollar' },
      { code: 'cad', symbol: 'C$', name: 'Canadian Dollar' },
      { code: 'chf', symbol: 'Fr', name: 'Swiss Franc' },
      { code: 'sgd', symbol: 'S$', name: 'Singapore Dollar' },
      { code: 'hkd', symbol: 'HK$',name: 'Hong Kong Dollar' },
      { code: 'sek', symbol: 'kr', name: 'Swedish Krona' },
      { code: 'nok', symbol: 'kr', name: 'Norwegian Krone' },
      { code: 'dkk', symbol: 'kr', name: 'Danish Krone' },
      { code: 'nzd', symbol: 'NZ$',name: 'New Zealand Dollar' },
      { code: 'zar', symbol: 'R',  name: 'South African Rand' },
      { code: 'brl', symbol: 'R$', name: 'Brazilian Real' },
      { code: 'mxn', symbol: 'Mex$',name: 'Mexican Peso' },
      { code: 'krw', symbol: '₩',  name: 'South Korean Won' },
      { code: 'thb', symbol: '฿',  name: 'Thai Baht' },
    ];

    let arbData = null;
    let fxRates = {};

    const fmt = (n, d = 2) => '$' + n.toLocaleString('en-US', { minimumFractionDigits: d, maximumFractionDigits: d });
    const fmtCur = (n, sym, d = 2) => sym + n.toLocaleString('en-US', { minimumFractionDigits: d, maximumFractionDigits: d });
    const fmtINR = (n) => '₹' + n.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const fmtCompact = (n) => {
      if (n >= 1e12) return '$' + (n / 1e12).toFixed(2) + 'T';
      if (n >= 1e9) return '$' + (n / 1e9).toFixed(2) + 'B';
      if (n >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
      return '$' + n.toLocaleString();
    };

    function buildCards() {
      const cc = document.getElementById('crypto-cards');
      const sc = document.getElementById('stable-cards');
      coins.forEach(coin => {
        const isStable = coin.section === 'stable';
        const card = document.createElement('div');
        card.className = 'card' + (isStable ? ' stablecoin' : '');
        card.id = `${coin.symbol.toLowerCase()}-card`;
        const k = coin.symbol.toLowerCase();
        card.innerHTML = `
          <div class="card-header">
            <img class="coin-icon" src="${coin.icon}" alt="${coin.symbol}">
            <div><div class="coin-name">${coin.name}</div><div class="coin-symbol">${coin.symbol}</div></div>
          </div>
          <div class="price" id="${k}-price">--${isStable ? `<span class="peg-status" id="${k}-peg"></span>` : ''}</div>
          <div class="stats">
            <div><div class="stat-label">24h Change</div><div class="stat-value" id="${k}-change">--</div></div>
            <div><div class="stat-label">Market Cap</div><div class="stat-value" id="${k}-mcap">--</div></div>
            <div><div class="stat-label">${isStable ? '24h Volume' : '24h High'}</div><div class="stat-value" id="${k}-extra">--</div></div>
          </div>`;
        (isStable ? sc : cc).appendChild(card);
      });
    }

    function buildCalcCurrencySelect() {
      const sel = document.getElementById('calc-currency-select');
      currencies.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.code;
        opt.textContent = `${c.code.toUpperCase()} - ${c.name}`;
        if (c.code === 'inr') opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function updateArbitrage(stableData, usdInr) {
      const container = document.getElementById('arb-content');
      if (stableData.length < 2) {
        container.innerHTML = '<p class="no-arb">Need at least 2 stablecoins.</p>';
        return;
      }
      const sorted = [...stableData].sort((a, b) => a.current_price - b.current_price);
      const buyC = sorted[0], sellC = sorted[sorted.length - 1];
      const spread = sellC.current_price - buyC.current_price;
      const spreadPct = (spread / buyC.current_price) * 100;
      const netSpreadPct = spreadPct - (TOTAL_FEE * 100);
      const buyName = coins.find(c => c.id === buyC.id)?.symbol || buyC.symbol;
      const sellName = coins.find(c => c.id === sellC.id)?.symbol || sellC.symbol;

      arbData = { buyC, sellC, buyName, sellName, spread, spreadPct, netSpreadPct, usdInr };
      const profitable = netSpreadPct > 0;

      container.innerHTML = `
        <div class="arb-strategy">
          <div class="arb-flow">
            <div class="arb-step"><div class="step-num">Step 1</div><div class="step-action">Deposit Currency</div><div class="step-detail">Bank / Wire / UPI</div></div>
            <div class="arb-arrow">&rarr;</div>
            <div class="arb-step" style="border-color:#2e7d32;"><div class="step-num">Step 2 &middot; Buy</div><div class="step-action" style="color:#2e7d32;">${buyName}</div><div class="step-detail">${fmt(buyC.current_price, 4)} (cheapest)</div></div>
            <div class="arb-arrow">&rarr;</div>
            <div class="arb-step"><div class="step-num">Step 3 &middot; Swap</div><div class="step-action">${buyName} &rarr; ${sellName}</div><div class="step-detail">DEX or Binance Convert</div></div>
            <div class="arb-arrow">&rarr;</div>
            <div class="arb-step" style="border-color:#c62828;"><div class="step-num">Step 4 &middot; Sell</div><div class="step-action" style="color:#c62828;">${sellName}</div><div class="step-detail">${fmt(sellC.current_price, 4)} (highest)</div></div>
            <div class="arb-arrow">&rarr;</div>
            <div class="arb-step"><div class="step-num">Step 5</div><div class="step-action">Withdraw Currency</div><div class="step-detail">Bank Transfer</div></div>
          </div>
        </div>
        <div class="arb-summary">
          <div class="arb-stat"><div class="label">Gross Spread (per coin)</div><div class="value">${fmt(spread, 4)} (${spreadPct.toFixed(3)}%)</div></div>
          <div class="arb-stat"><div class="label">Total Fees</div><div class="value amber">-${(TOTAL_FEE * 100).toFixed(2)}%</div></div>
          <div class="arb-stat"><div class="label">Net Spread (per coin)</div><div class="value ${profitable ? 'green' : 'red'}">${netSpreadPct.toFixed(3)}%</div></div>
          <div class="arb-stat"><div class="label">Verdict</div><div class="value ${profitable ? 'green' : 'red'}">${profitable ? 'PROFITABLE' : 'FEES EXCEED SPREAD'}</div></div>
        </div>`;

      updateCalculator();
    }

    function updateMultiCurrency(multiData) {
      const results = [];
      for (const cur of currencies) {
        const prices = multiData[cur.code];
        if (!prices || prices.length < 2) continue;
        const sorted = [...prices].sort((a, b) => a.price - b.price);
        const buyP = sorted[0], sellP = sorted[sorted.length - 1];
        const spread = sellP.price - buyP.price;
        const spreadPct = (spread / buyP.price) * 100;
        const netPct = spreadPct - (TOTAL_FEE * 100);
        results.push({
          cur, buyP, sellP, spread, spreadPct, netPct,
          buySymbol: coins.find(c => c.id === buyP.id)?.symbol || buyP.id,
          sellSymbol: coins.find(c => c.id === sellP.id)?.symbol || sellP.id,
        });
      }

      results.sort((a, b) => b.netPct - a.netPct);

      const container = document.getElementById('currency-leaderboard');
      if (results.length === 0) {
        container.innerHTML = '<p class="no-arb">No data available.</p>';
        return;
      }

      let rows = results.map((r, i) => {
        const rankBadge = i < 3 ? `<span class="rank-badge rank-${i+1}">#${i+1}</span>` : '';
        const profitable = r.netPct > 0;
        return `<tr>
          <td>${r.cur.code.toUpperCase()} ${rankBadge}</td>
          <td>${r.cur.name}</td>
          <td>${r.buySymbol} &rarr; ${r.sellSymbol}</td>
          <td>${r.spreadPct.toFixed(4)}%</td>
          <td class="${profitable ? 'change-positive' : 'change-negative'}">${r.netPct.toFixed(4)}%</td>
          <td class="${profitable ? 'change-positive' : 'change-negative'}">${profitable ? 'YES' : 'NO'}</td>
        </tr>`;
      }).join('');

      container.innerHTML = `<div style="overflow-x:auto;">
        <table class="vol-table">
          <thead><tr><th>Currency</th><th>Name</th><th>Best Pair</th><th>Gross Spread</th><th>Net Spread</th><th>Profitable?</th></tr></thead>
          <tbody>${rows}</tbody>
        </table></div>`;

      const sel = document.getElementById('currency-detail-select');
      const prevVal = sel.value;
      sel.innerHTML = '<option value="">Select a currency...</option>';
      results.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.cur.code;
        opt.textContent = `${r.cur.code.toUpperCase()} - ${r.cur.name} (net: ${r.netPct.toFixed(4)}%)`;
        sel.appendChild(opt);
      });
      if (prevVal) sel.value = prevVal;

      window._currencyResults = results;
      if (sel.value) showCurrencyDetail(sel.value);
    }

    function showCurrencyDetail(code) {
      const container = document.getElementById('currency-detail');
      const results = window._currencyResults;
      if (!results) return;
      const r = results.find(x => x.cur.code === code);
      if (!r) { container.innerHTML = ''; return; }

      const investEquiv = 1000000;
      const rateToUsd = fxRates['usd'] && fxRates[code] ? fxRates[code] / fxRates['usd'] : null;
      const profitable = r.netPct > 0;

      let profitSection = '';
      if (rateToUsd && profitable) {
        const investUSD = investEquiv / rateToUsd;
        const numCoins = investUSD / (r.buyP.price / rateToUsd);
        const grossUSD = numCoins * r.spread / rateToUsd;
        const feesUSD = investUSD * TOTAL_FEE;
        const netUSD = grossUSD - feesUSD;
        const netLocal = netUSD * rateToUsd;
        const inrRate = fxRates['inr'] / fxRates['usd'];
        const netINR = netUSD * inrRate;
        profitSection = `
          <div style="margin-top:16px;">
            <div style="color:#999; font-size:0.8rem; margin-bottom:8px;">Profit on ${r.cur.symbol}${investEquiv.toLocaleString()} invested:</div>
            <div class="arb-summary">
              <div class="arb-stat"><div class="label">Gross Profit</div><div class="value">${r.cur.symbol}${(grossUSD * rateToUsd).toFixed(2)}</div></div>
              <div class="arb-stat"><div class="label">Fees</div><div class="value amber">${r.cur.symbol}${(feesUSD * rateToUsd).toFixed(2)}</div></div>
              <div class="arb-stat"><div class="label">Net Profit (${r.cur.code.toUpperCase()})</div><div class="value green">${r.cur.symbol}${netLocal.toFixed(2)}</div></div>
              <div class="arb-stat"><div class="label">Net Profit (INR)</div><div class="value green">${fmtINR(netINR)}</div></div>
            </div>
          </div>`;
      }

      container.innerHTML = `
        <div class="currency-detail">
          <h3 style="margin-bottom:12px; color:#1a1a2e;">${r.cur.code.toUpperCase()} - ${r.cur.name}</h3>
          <div class="arb-summary">
            <div class="arb-stat"><div class="label">Buy (Cheapest)</div><div class="value green">${r.buySymbol} @ ${r.cur.symbol}${r.buyP.price.toFixed(4)}</div></div>
            <div class="arb-stat"><div class="label">Sell (Most Expensive)</div><div class="value red">${r.sellSymbol} @ ${r.cur.symbol}${r.sellP.price.toFixed(4)}</div></div>
            <div class="arb-stat"><div class="label">Gross Spread</div><div class="value">${r.cur.symbol}${r.spread.toFixed(4)} (${r.spreadPct.toFixed(4)}%)</div></div>
            <div class="arb-stat"><div class="label">Net Spread</div><div class="value ${profitable ? 'green' : 'red'}">${r.netPct.toFixed(4)}%</div></div>
          </div>
          ${profitSection}
        </div>`;
    }

    document.getElementById('currency-detail-select').addEventListener('change', (e) => showCurrencyDetail(e.target.value));

    function updateCalculator() {
      const investVal = parseFloat(document.getElementById('invest-input').value);
      if (!arbData || !investVal || investVal <= 0) return;

      const { buyC, spread, buyName } = arbData;
      const selCode = document.getElementById('calc-currency-select').value || 'inr';
      const cur = currencies.find(c => c.code === selCode);
      const localRate = fxRates[selCode] || 1;
      const usdRate = fxRates['usd'] || 1;
      const inrRate = fxRates['inr'] || 83.5;
      const toUsd = usdRate / localRate;

      const investUSD = investVal * toUsd;
      const numCoins = investUSD / buyC.current_price;
      const grossProfit = numCoins * spread;

      const feeBuy = investUSD * FEES.buyTrade;
      const feeSwap = investUSD * FEES.swap;
      const feeSell = investUSD * FEES.sellTrade;
      const feeNet = investUSD * FEES.network;
      const feeFx = investUSD * FEES.fxSpread;
      const totalFees = feeBuy + feeSwap + feeSell + feeNet + feeFx;

      const netProfitUSD = grossProfit - totalFees;
      const netProfitLocal = netProfitUSD / toUsd;
      const netProfitINR = netProfitUSD * (inrRate / usdRate);
      const roi = (netProfitUSD / investUSD) * 100;

      document.getElementById('calc-usd').textContent = fmt(investUSD, 2);
      document.getElementById('calc-coins').textContent = Math.floor(numCoins).toLocaleString() + ' ' + buyName;
      document.getElementById('calc-gross-usd').textContent = fmt(grossProfit, 4);
      document.getElementById('calc-fee-buy').textContent = fmt(feeBuy, 4);
      document.getElementById('calc-fee-swap').textContent = fmt(feeSwap, 4);
      document.getElementById('calc-fee-sell').textContent = fmt(feeSell, 4);
      document.getElementById('calc-fee-network').textContent = fmt(feeNet, 4);
      document.getElementById('calc-fee-spread').textContent = fmt(feeFx, 4);
      document.getElementById('calc-fees-total').textContent = fmt(totalFees, 4);

      const netLocalEl = document.getElementById('calc-net-local');
      netLocalEl.textContent = fmtCur(netProfitLocal, cur?.symbol || '', 2) + ` (${selCode.toUpperCase()})`;
      netLocalEl.className = 'value ' + (netProfitLocal >= 0 ? 'green' : 'red');

      const netInrEl = document.getElementById('calc-net-inr');
      netInrEl.textContent = fmtINR(netProfitINR);
      netInrEl.className = 'value ' + (netProfitINR >= 0 ? 'green' : 'red');

      const roiEl = document.getElementById('calc-roi');
      roiEl.textContent = roi.toFixed(3) + '%';
      roiEl.className = 'value ' + (roi >= 0 ? 'green' : 'red');
    }

    document.getElementById('invest-input').addEventListener('input', updateCalculator);
    document.getElementById('calc-currency-select').addEventListener('change', updateCalculator);

    const PROXY = 'https://corsproxy.io/?';
    const API = 'https://api.coingecko.com/api/v3';

    async function fetchWithFallback(url) {
      try {
        const res = await fetch(url);
        if (res.ok) return res;
      } catch (e) { /* direct failed, try proxy */ }
      return fetch(PROXY + encodeURIComponent(url));
    }

    async function fetchPrices() {
      document.querySelectorAll('.card').forEach(c => c.classList.add('loading'));

      try {
        const ids = coins.map(c => c.id).join(',');
        const currCodes = currencies.map(c => c.code).join(',');

        const [resUSD, resMulti] = await Promise.all([
          fetchWithFallback(`${API}/coins/markets?vs_currency=usd&ids=${ids}&order=market_cap_desc&sparkline=false&price_change_percentage=24h`),
          fetchWithFallback(`${API}/simple/price?ids=${stableIds.join(',')}&vs_currencies=${currCodes}`)
        ]);

        if (!resUSD.ok) throw new Error(`HTTP ${resUSD.status}`);
        const data = await resUSD.json();

        let multiRaw = {};
        if (resMulti.ok) multiRaw = await resMulti.json();

        if (multiRaw.tether) {
          fxRates = { ...multiRaw.tether };
        }

        const usdInr = fxRates['inr'] || 83.5;

        const multiData = {};
        for (const cur of currencies) {
          multiData[cur.code] = [];
          for (const sid of stableIds) {
            if (multiRaw[sid] && multiRaw[sid][cur.code] != null) {
              multiData[cur.code].push({ id: sid, price: multiRaw[sid][cur.code] });
            }
          }
        }

        const stableData = [];
        data.forEach(apiCoin => {
          const coin = coins.find(c => c.id === apiCoin.id);
          if (!coin) return;
          const k = coin.symbol.toLowerCase();
          const isStable = coin.section === 'stable';
          if (isStable) stableData.push(apiCoin);

          const priceEl = document.getElementById(`${k}-price`);
          const priceText = fmt(apiCoin.current_price, isStable ? 4 : 2);
          if (isStable) {
            const pegEl = document.getElementById(`${k}-peg`);
            const dev = Math.abs(apiCoin.current_price - coin.peg);
            pegEl.textContent = dev < 0.005 ? 'ON PEG' : 'DEPEG';
            pegEl.className = 'peg-status ' + (dev < 0.005 ? 'peg-ok' : 'peg-warn');
            priceEl.innerHTML = priceText + pegEl.outerHTML;
          } else {
            priceEl.textContent = priceText;
          }

          const changeEl = document.getElementById(`${k}-change`);
          const ch = apiCoin.price_change_percentage_24h || 0;
          changeEl.textContent = (ch >= 0 ? '+' : '') + ch.toFixed(2) + '%';
          changeEl.className = 'stat-value ' + (ch >= 0 ? 'change-positive' : 'change-negative');

          document.getElementById(`${k}-mcap`).textContent = fmtCompact(apiCoin.market_cap);
          const extra = isStable ? apiCoin.total_volume : apiCoin.high_24h;
          document.getElementById(`${k}-extra`).textContent = isStable ? fmtCompact(extra) : fmt(extra);
        });

        updateArbitrage(stableData, usdInr);
        updateMultiCurrency(multiData);

        document.getElementById('status-dot').className = 'dot';
        document.getElementById('status-text').textContent = 'Updated ' + new Date().toLocaleTimeString();
      } catch (err) {
        document.getElementById('status-dot').className = 'dot error';
        document.getElementById('status-text').textContent = 'Error: ' + err.message;
      } finally {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('loading'));
      }
    }

    buildCards();
    buildCalcCurrencySelect();
    fetchPrices();
    setInterval(fetchPrices, 30000);
  </script>
</body>
</html>
